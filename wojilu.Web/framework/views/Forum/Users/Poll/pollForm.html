<style>    
    .pollOptionWrap td { padding: 3px 3px 3px 8px;}
</style>

<div class="poll-wrap">

    <div class="poll-container">
        <div class="poll-container-inner">
            <table class="poll-v-table" id="pollOption#{topicId}">
            <!-- BEGIN options -->
            <tr>
                <td class="poll-v-item">#{op.SelectControl}</td>
            </tr><!-- END options -->
            </table>

            <div class="note" style="margin-left:15px;">#{poll.ExpiryInfo}</div>

            <div style="margin:10px 15px;">

                <!-- BEGIN cmdVote -->             

                <button id="btnPoll#{poll.Id}" type="button" class="btn btn-primary right10" cid="poll_#{poll.Id}">
                    <img src="~static/skin/apps/forum/wojilu.Apps.Forum.Domain.ForumPoll.gif" />
                    _{pollVote}
                </button>
                <!-- END cmdVote -->
            
                <!-- BEGIN plsVote -->
                <span class="right10">_{pollLoginRequire}</span>
                <!-- END plsVote -->

                <!-- BEGIN lnkView -->
                <span class="link cmdViewResult strong" topicId="#{topicId}">&raquo; 查看结果</span>
                <!-- END lnkView -->

                <!-- BEGIN lblView -->
                <span class="alert alert-warning">投票之后才能查看结果</span>
                <span class="hide cmdViewResult" topicId="#{topicId}"></span>
                <!-- END lblView -->

            </div>
        </div>
    </div>
</div>


<script>

    $(document).ready(function () {

        function bindViewForm() {
            $('.cmdViewForm').click(function () {
                var topicId = $(this).attr('topicId');
                $('#pollFormWrap' + topicId).show();
                $('#pollResultWrap' + topicId).hide();
            });
        }

        function refreshResult() {
            var getResultHtmlLink = '#{getResultHtmlLink}'.toAjax();
            $.post(getResultHtmlLink, function (data) {
                $('#pollResultWrap#{topicId}').html(data);
                bindViewForm();
            });
        }

        $('#btnPoll#{poll.Id}').click(function () {
            var ctx = $('#pollOption#{topicId}');

            var selectedControl = $('input[name=pollOption]:checked', ctx);
            var pValue = selectedControl.serialize();
            if (wojilu.str.hasText(pValue) == false) {
                alert('_{pollSelectRequire}');
                return false;
            }

            $(this).attr('disabled', 'disabled');
            $(this).val('你已经投过票');
            var voteLink = '#{poll.VoteLink}'.toAjax();

            $.post(voteLink, pValue, function (data) {

                if ('ok' == data) {
                    refreshResult();
                    $('.cmdViewResult').click();
                } else {
                    //var msg = eval('(' + data + ')');
                    alert(data.Msg);
                }
            });
        });

    });

</script>
